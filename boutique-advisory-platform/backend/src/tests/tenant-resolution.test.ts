import test from 'node:test';
import assert from 'node:assert';
import { getTenantId } from '../utils/tenant-utils';

type MinimalReq = {
  hostname?: string;
  headers: Record<string, string | undefined>;
};

function withEnv<T>(vars: Record<string, string | undefined>, fn: () => T): T {
  const previous: Record<string, string | undefined> = {};
  for (const [k, v] of Object.entries(vars)) {
    previous[k] = process.env[k];
    if (v === undefined) {
      delete process.env[k];
    } else {
      process.env[k] = v;
    }
  }

  try {
    return fn();
  } finally {
    for (const [k, v] of Object.entries(previous)) {
      if (v === undefined) {
        delete process.env[k];
      } else {
        process.env[k] = v;
      }
    }
  }
}

test('Tenant resolution - production uses hostname and ignores x-tenant-id', () => {
  withEnv({ NODE_ENV: 'production' }, () => {
    const req = {
      hostname: 'tenant1.cambobia.com',
      headers: { 'x-tenant-id': 'attacker-tenant' },
    } as unknown as MinimalReq;

    const tenantId = getTenantId(req as any);
    assert.strictEqual(tenantId, 'tenant1');
  });
});

test('Tenant resolution - local/railway host falls back to default in production', () => {
  withEnv({ NODE_ENV: 'production' }, () => {
    const railwayReq = {
      hostname: 'my-app.up.railway.app',
      headers: {},
    } as unknown as MinimalReq;
    assert.strictEqual(getTenantId(railwayReq as any), 'default');

    const localhostReq = {
      hostname: 'localhost',
      headers: {},
    } as unknown as MinimalReq;
    assert.strictEqual(getTenantId(localhostReq as any), 'default');
  });
});

test('Tenant resolution - development can use x-tenant-id override', () => {
  withEnv({ NODE_ENV: 'development' }, () => {
    const req = {
      hostname: 'localhost',
      headers: { 'x-tenant-id': 'dev-tenant' },
    } as unknown as MinimalReq;

    assert.strictEqual(getTenantId(req as any), 'dev-tenant');
  });
});
